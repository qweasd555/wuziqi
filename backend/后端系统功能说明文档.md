# 五子棋游戏后端系统功能说明文档

## 1. 项目概述

### 1.1 项目简介
这是一个基于Spring Boot开发的五子棋游戏后端系统，提供实时对战、人机对战和独特的技能系统功能。系统采用RESTful API和WebSocket双重通信机制，支持多种游戏模式和丰富的技能效果。

### 1.2 技术栈
- **框架**: Spring Boot 3.2.3
- **数据库**: H2 (开发环境) / MySQL (生产环境)
- **ORM**: Spring Data JPA + Hibernate
- **实时通信**: WebSocket + STOMP协议
- **安全框架**: Spring Security
- **构建工具**: Maven
- **前端代理**: 支持CORS跨域配置

## 2. 项目结构详解

### 2.1 项目根目录结构
```
backend/
├── .gitattributes          # Git属性配置
├── .gitignore             # Git忽略规则
├── HELP.md                # 项目帮助文档
├── backend.iml            # IntelliJ IDEA模块配置
├── pom.xml                # Maven项目配置文件
├── mvnw                   # Maven Wrapper脚本(Unix/Linux)
├── mvnw.cmd               # Maven Wrapper脚本(Windows)
├── package.json           # Node.js配置(用于测试工具)
├── package-lock.json      # NPM依赖锁定文件
├── .mvn/                  # Maven Wrapper配置目录
├── images/                # 项目图片资源
└── src/                   # 源代码目录
```

### 2.2 源代码结构 (`src`)
```
src/
├── main/
│   ├── java/com/skillfive/backend/
│   │   ├── BackendApplication.java  # 主应用程序入口
│   │   ├── config/                   # 配置类
│   │   │   ├── AsyncConfig.java     # 异步处理配置
│   │   │   ├── DatabaseConfig.java  # 数据库配置
│   │   │   ├── SecurityConfig.java  # 安全配置
│   │   │   └── WebConfig.java       # Web配置(CORS等)
│   │   ├── controller/               # 控制器层
│   │   │   ├── GameController.java  # 游戏相关API
│   │   │   ├── UserController.java  # 用户管理API
│   │   │   ├── SkillController.java # 技能系统API
│   │   │   ├── WechatController.java# 微信相关API
│   │   │   └── HealthController.java# 健康检查API
│   │   ├── dto/                      # 数据传输对象
│   │   │   ├── SkillEffectResponse.java
│   │   │   └── SkillUseRequest.java
│   │   ├── entity/                   # 实体类
│   │   │   ├── Game.java            # 游戏实体
│   │   │   ├── User.java            # 用户实体
│   │   │   ├── Skill.java           # 技能实体
│   │   │   └── GameRecord.java     # 游戏记录实体
│   │   ├── enums/                    # 枚举类
│   │   │   ├── GameMode.java        # 游戏模式
│   │   │   ├── GameType.java        # 游戏类型
│   │   │   ├── SkillType.java       # 技能类型
│   │   │   └── SkillEffectType.java # 技能效果类型
│   │   ├── exception/                # 异常处理
│   │   │   ├── GlobalExceptionHandler.java # 全局异常处理
│   │   │   ├── BaseException.java   # 基础异常类
│   │   │   ├── BusinessException.java # 业务异常
│   │   │   ├── ResourceNotFoundException.java # 资源未找到异常
│   │   │   └── UnauthorizedException.java # 未授权异常
│   │   ├── repository/               # 数据访问层
│   │   │   ├── GameRepository.java  # 游戏数据访问
│   │   │   ├── UserRepository.java  # 用户数据访问
│   │   │   ├── SkillRepository.java # 技能数据访问
│   │   │   └── GameRecordRepository.java # 游戏记录数据访问
│   │   ├── service/                  # 服务层
│   │   │   ├── GameService.java      # 游戏服务
│   │   │   ├── GameFlowService.java  # 游戏流程服务
│   │   │   ├── UserService.java      # 用户服务
│   │   │   ├── SkillService.java     # 技能服务
│   │   │   └── AiService.java        # AI服务
│   │   ├── websocket/                # WebSocket通信
│   │   │   ├── WebSocketConfig.java # WebSocket配置
│   │   │   ├── WebSocketHandler.java# WebSocket消息处理器
│   │   │   ├── WebSocketController.java # WebSocket控制器
│   │   │   ├── WebSocketSessionManager.java # 会话管理
│   │   │   ├── WebSocketMessage.java # WebSocket消息实体
│   │   │   └── WebSocketInterceptor.java # WebSocket拦截器
│   │   ├── util/                     # 工具类
│   │   └── utils/                    # 工具类
│   └── resources/
│       ├── application.yml          # 应用配置文件
│       └── static/                  # 静态资源
│           ├── health.html          # 健康检查页面
│           ├── websocket-test.html  # WebSocket测试页面
│           ├── skill-test.html      # 技能测试页面
│           ├── test-websocket-native.html # 原生WebSocket测试
│           ├── favicon.ico          # 网站图标
│           ├── css/                 # CSS文件
│           │   └── game.css         # 游戏相关样式
│           └── js/                  # JavaScript文件
│               ├── app.js           # 应用脚本
│               └── game.js          # 游戏脚本
└── test/                            # 测试代码
    └── java/com/skillfive/backend/
        └── BackendApplicationTests.java # 基础测试类
```

### 2.3 构建输出目录 (`target`)
```
target/
├── backend-0.0.1-SNAPSHOT.jar      # 可执行JAR文件(含依赖)
├── backend-0.0.1-SNAPSHOT.jar.original # 原始JAR文件(不含依赖)
├── classes/                         # 编译后的类文件
│   ├── application.yml              # 复制的配置文件
│   └── com/skillfive/backend/       # 编译后的Java类
├── generated-sources/               # 自动生成的源代码
├── maven-archiver/                  # Maven归档信息
├── maven-status/                    # Maven构建状态
└── test-classes/                   # 编译后的测试类
```

## 3. 系统功能详解

### 3.1 游戏系统

#### 3.1.1 游戏模式
- **REGULAR** (常规模式): 标准五子棋规则，无技能系统
- **SKILL** (技能模式): 包含特殊技能的增强模式

#### 3.1.2 游戏类型
- **VS_AI** (人机对战): 与AI对手进行游戏
- **LOCAL_PVP** (本地对战): 本地双人对战
- **ONLINE_PVP** (在线对战): 网络多人对战

#### 3.1.3 游戏流程
1. **创建游戏**: 指定游戏模式和类型，初始化棋盘
2. **加入游戏**: 第二名玩家加入或AI自动加入
3. **开始游戏**: 系统自动开始游戏，分配先手
4. **游戏进行**: 玩家轮流下棋，可使用技能
5. **游戏结束**: 判断胜负或平局，记录结果

### 3.2 技能系统

#### 3.2.1 技能类型
- **ATTACK** (攻击型): 直接影响对手棋子的技能
- **DEFENSE** (防御型): 保护自己棋子的技能
- **UTILITY** (功能型): 提供特殊效果的技能

#### 3.2.2 技能效果类型
- **BOARD_RESET**: 重置棋盘，清空所有棋子
- **EXTRA_TURN**: 额外回合，玩家可连续行动
- **REMOVE_PIECE**: 移除棋子，移除指定位置的棋子
- **SWAP_PIECES**: 交换棋子，交换两个位置的棋子
- **FORCE_MOVE**: 强制移动，强制对手在指定位置下棋
- **TIME_EXTENSION**: 时间延长，增加回合时间限制
- **SHIELD**: 护盾，免疫一次技能效果
- **REFLECT**: 反射，将技能效果反射给施法者
- **COPY**: 复制，复制对手的上一个技能
- **CHAOS**: 混乱，随机改变棋盘上的几个棋子
- **FORESIGHT**: 透视，查看对手的下一步可能行动
- **TELEPORT**: 传送，将一个棋子传送到另一个位置
- **FREEZE**: 冻结，冻结对手的某个棋子
- **BURN**: 燃烧，在指定位置放置一个会消失的棋子
- **HEAL**: 治愈，恢复被移除的己方棋子

#### 3.2.3 技能机制
- 每个技能有独立的冷却时间
- 技能使用会消耗游戏资源
- 技能效果可以组合和抵消
- 技能使用记录会被保存

### 3.3 AI系统

AI系统提供人机对战功能，具有以下特点：
- 多难度级别选择
- 基于评估函数的最优决策
- 支持技能模式对战
- 模拟人类玩家行为模式

### 3.4 用户系统

用户系统管理玩家信息：
- 用户注册和认证
- 游戏历史记录
- 技能使用统计
- 排行榜积分

## 4. API接口详解

### 4.1 游戏相关API

#### 4.1.1 创建游戏
```
POST /api/game/create
参数: {
  userId: Long,
  mode: GameMode, // REGULAR, SKILL
  type: GameType  // VS_AI, LOCAL_PVP, ONLINE_PVP
}
返回: {
  success: boolean,
  gameId: Long,
  status: String,
  type: GameType,
  message: String
}
```

#### 4.1.2 加入游戏
```
POST /api/game/{gameId}/join
参数: {
  userId: Long
}
返回: Game对象
```

#### 4.1.3 获取游戏信息
```
GET /api/game/{gameId}
返回: Game对象
```

### 4.2 技能相关API

#### 4.2.1 使用技能
```
POST /api/skill/use
参数: SkillUseRequest {
  gameId: Long,
  userId: Long,
  skillId: Long,
  targetPosition: Position, // 可选
  parameters: Map // 可选参数
}
返回: SkillEffectResponse {
  success: boolean,
  effectType: SkillEffectType,
  effectDescription: String,
  gameStateChange: GameStateChange,
  cooldownRemaining: Integer
}
```

### 4.3 用户相关API

#### 4.3.1 获取用户信息
```
GET /api/user/{userId}
返回: User对象
```

#### 4.3.2 获取用户游戏历史
```
GET /api/user/{userId}/history
返回: List<GameRecord>
```

### 4.4 WebSocket通信

#### 4.4.1 连接端点
```
ws://localhost:8081/ws
```

#### 4.4.2 消息类型
- **GAME_MOVE**: 游戏移动
- **SKILL_USE**: 技能使用
- **GAME_UPDATE**: 游戏状态更新
- **PLAYER_JOIN**: 玩家加入
- **PLAYER_LEAVE**: 玩家离开
- **CHAT_MESSAGE**: 聊天消息

#### 4.4.3 消息格式
```json
{
  "type": "消息类型",
  "userId": "用户ID",
  "gameId": "游戏ID",
  "data": "具体数据",
  "timestamp": "时间戳"
}
```

## 5. 数据库设计

### 5.1 用户表 (users)
```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(100) NOT NULL,
  nickname VARCHAR(50),
  avatar VARCHAR(255),
  email VARCHAR(100),
  score INTEGER DEFAULT 0,
  wins INTEGER DEFAULT 0,
  losses INTEGER DEFAULT 0,
  created_time TIMESTAMP,
  updated_time TIMESTAMP
);
```

### 5.2 游戏表 (games)
```sql
CREATE TABLE games (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  mode VARCHAR(20), -- REGULAR, SKILL
  type VARCHAR(20), -- VS_AI, LOCAL_PVP, ONLINE_PVP
  player1_id BIGINT,
  player2_id BIGINT,
  board_state TEXT, -- 棋盘状态JSON
  current_player INTEGER DEFAULT 1,
  winner VARCHAR(20), -- player1, player2, draw
  start_time TIMESTAMP,
  end_time TIMESTAMP,
  status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, IN_PROGRESS, FINISHED
  player1_skills TEXT, -- 玩家1技能JSON
  player2_skills TEXT, -- 玩家2技能JSON
  used_skills TEXT,    -- 已使用技能记录
  game_data TEXT,       -- 游戏额外数据
  last_move TEXT,       -- 最后一步操作描述
  created_time TIMESTAMP,
  updated_time TIMESTAMP,
  FOREIGN KEY (player1_id) REFERENCES users(id),
  FOREIGN KEY (player2_id) REFERENCES users(id)
);
```

### 5.3 技能表 (skills)
```sql
CREATE TABLE skills (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL,
  description TEXT,
  type VARCHAR(20), -- ATTACK, DEFENSE, UTILITY
  effect_type VARCHAR(30), -- 具体效果类型
  cooldown INTEGER, -- 冷却时间(秒)
  cost INTEGER, -- 消耗
  duration INTEGER, -- 持续时间(秒)
  range_value INTEGER, -- 影响范围
  damage_value INTEGER, -- 效果强度
  icon VARCHAR(255), -- 技能图标
  created_time TIMESTAMP,
  updated_time TIMESTAMP
);
```

### 5.4 游戏记录表 (game_records)
```sql
CREATE TABLE game_records (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  game_id BIGINT NOT NULL,
  player_id BIGINT NOT NULL,
  result VARCHAR(20), -- WIN, LOSE, DRAW
  score_change INTEGER,
  duration_seconds INTEGER,
  moves_count INTEGER,
  skills_used TEXT, -- 使用的技能记录
  created_time TIMESTAMP,
  FOREIGN KEY (game_id) REFERENCES games(id),
  FOREIGN KEY (player_id) REFERENCES users(id)
);
```

## 6. 部署和运行

### 6.1 开发环境运行
```bash
# 使用Maven Wrapper运行
./mvnw spring-boot:run

# 或直接使用JAR文件
java -jar target/backend-0.0.1-SNAPSHOT.jar
```

### 6.2 生产环境部署
```bash
# 构建JAR文件
./mvnw clean package

# 运行JAR文件
java -jar target/backend-0.0.1-SNAPSHOT.jar
```

### 6.3 配置说明
开发环境使用H2内存数据库，生产环境需要修改application.yml配置为MySQL：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/wuziqi
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: your_username
    password: your_password
```

### 6.4 健康检查
访问 http://localhost:8081/health.html 查看系统健康状态

### 6.5 WebSocket测试
访问 http://localhost:8081/websocket-test.html 测试WebSocket连接

## 7. 扩展和维护

### 7.1 添加新技能
1. 在SkillEffectType枚举中添加新效果类型
2. 在SkillService中实现新效果逻辑
3. 更新前端技能显示和交互
4. 添加技能图标和描述

### 7.2 优化AI算法
1. 修改AiService中的评估函数
2. 增加难度级别选择
3. 实现更复杂的棋型识别
4. 添加开局库和残局库

### 7.3 性能优化
1. 添加Redis缓存用户会话
2. 优化WebSocket消息处理
3. 实现数据库连接池
4. 添加日志记录和监控

## 8. 常见问题解决

### 8.1 WebSocket连接失败
- 检查防火墙设置
- 确认端口8081未被占用
- 验证CORS配置是否正确

### 8.2 数据库连接问题
- 确认数据库服务已启动
- 检查连接URL和凭据
- 验证表结构是否正确创建

### 8.3 技能效果异常
- 检查技能参数是否合法
- 验证目标位置是否有效
- 确认冷却时间是否正确计算

## 9. 版本历史

- **v0.0.1-SNAPSHOT**: 初始版本，实现基础五子棋功能
- **v0.0.2-SNAPSHOT**: 添加技能系统和AI对战
- **v0.0.3-SNAPSHOT**: 完善WebSocket通信和异常处理
- **v0.0.4-SNAPSHOT**: 优化性能和安全性

---

*本文档最后更新时间: 2025-12-05*