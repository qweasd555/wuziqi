# SkillFive 后端项目说明

## 📋 项目概述

这是 SkillFive（趣味技能五子棋）游戏的后端服务，负责处理游戏逻辑、数据存储和实时对战功能。

## 🎯 核心功能

### 1. 用户系统
- ✅ 微信授权登录
- ✅ 用户信息管理
- ✅ 积分和段位系统
- ✅ 战绩统计

### 2. 游戏核心逻辑
- ✅ 15x15 棋盘管理
- ✅ 落子合法性验证
- ✅ 胜负判定算法（横、竖、斜三方向）
- ✅ 平局检测

### 3. 技能系统（10种技能）
- ✅ 连环落子 ⚡
- ✅ 透视眼 👁️
- ✅ 强制落子 🎯
- ✅ 交换棋子 🔄
- ✅ 封印 🔒
- ✅ 悔棋 ↩️
- ✅ 护盾 🛡️
- ✅ 预言术 🔮
- ✅ 清空术 🧹
- ✅ 蒙蔽术 👻

### 4. AI 对战
- ✅ 三种难度（简单/中等/困难）
- ✅ 威胁分析算法
- ✅ 位置评估函数
- ✅ 自动落子

### 5. 实时对战（WebSocket）
- ✅ 房间管理
- ✅ 实时同步棋盘状态
- ✅ 技能效果广播
- ✅ 游戏结束通知

### 6. 数据存储
- ✅ 用户数据（MongoDB）
- ✅ 对局记录
- ✅ 战绩统计
- ✅ 排行榜

## 📁 项目结构

```
skillfive-backend/
├── src/
│   ├── app.js                    # 应用入口
│   ├── config/
│   │   └── database.js          # 数据库配置
│   ├── models/                   # 数据模型
│   │   ├── User.js              # 用户模型
│   │   ├── Game.js              # 对局模型
│   │   └── Record.js            # 战绩模型
│   ├── controllers/              # 控制器
│   │   ├── userController.js
│   │   ├── gameController.js
│   │   └── recordController.js
│   ├── services/                 # 业务逻辑
│   │   ├── gameLogic.js         # 游戏核心逻辑
│   │   ├── skillSystem.js       # 技能系统
│   │   ├── aiService.js         # AI 对战
│   │   └── socketHandler.js     # WebSocket 处理
│   ├── routes/                   # 路由
│   │   ├── userRoutes.js
│   │   ├── gameRoutes.js
│   │   └── recordRoutes.js
│   └── middleware/
│       └── errorHandler.js      # 错误处理
├── .env.example                  # 环境变量示例
├── package.json
└── README.md
```

## 🚀 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 配置环境变量

复制 `.env.example` 为 `.env`：

```env
PORT=3000
MONGODB_URI=mongodb://localhost:27017/skillfive
JWT_SECRET=your-secret-key
WECHAT_APPID=your-wechat-appid
WECHAT_SECRET=your-wechat-secret
```

### 3. 启动 MongoDB

确保 MongoDB 服务正在运行。

### 4. 启动服务

开发模式：
```bash
npm run dev
```

生产模式：
```bash
npm start
```

## 📡 API 接口

### 用户相关

- `POST /api/user/login` - 微信登录
- `GET /api/user/:userId` - 获取用户信息
- `PUT /api/user/:userId` - 更新用户信息
- `GET /api/user/:userId/stats` - 获取用户统计

### 游戏相关

- `POST /api/game/create` - 创建对局
- `GET /api/game/:id` - 获取对局信息
- `POST /api/game/:id/move` - 落子
- `POST /api/game/:id/skill` - 使用技能
- `POST /api/game/:id/surrender` - 认输

### 战绩相关

- `POST /api/record/save` - 保存对局记录
- `GET /api/record/list` - 获取对战记录列表
- `GET /api/record/:id` - 获取单条记录详情
- `GET /api/record/rank/list` - 获取排行榜

## 🔌 WebSocket 事件

### 客户端发送

- `join-game` - 加入对局
  ```js
  { gameId: 'xxx' }
  ```

- `make-move` - 落子
  ```js
  { gameId: 'xxx', row: 7, col: 7, player: 1 }
  ```

- `use-skill` - 使用技能
  ```js
  { gameId: 'xxx', skillId: 'chain-move', player: 1, params: {...} }
  ```

- `surrender` - 认输
  ```js
  { gameId: 'xxx', player: 1 }
  ```

### 服务端推送

- `game-state` - 对局状态更新
- `move-result` - 落子结果
- `skill-effect` - 技能效果
- `game-over` - 游戏结束
- `error` - 错误信息

## 🎮 游戏逻辑说明

### 胜负判定

检查横、竖、斜（主对角线和副对角线）四个方向，任意方向连续5个相同棋子即获胜。

### 技能系统

1. **开局随机分配**：每个玩家随机获得3个技能
2. **单次使用**：每个技能每局只能使用一次
3. **技能效果**：立即生效或持续生效
4. **护盾机制**：可以免疫部分技能效果

### AI 算法

- **简单模式**：70% 随机落子
- **中等模式**：30% 随机，70% 使用评估函数
- **困难模式**：10% 随机，90% 使用评估函数 + 威胁分析

## 📊 数据库设计

### User 集合

- 用户基本信息
- 游戏统计数据
- 积分和段位
- 技能使用统计

### Game 集合

- 对局基本信息
- 棋盘状态（15x15）
- 落子记录
- 技能效果状态

### Record 集合

- 对局结果
- 玩家信息
- 落子记录（用于回放）
- 时间信息

## 🔧 开发建议

### 下一步工作

1. **完善微信登录**
   - 实现真实的微信 API 调用
   - 获取 openid 和 session_key

2. **优化 AI 算法**
   - 实现 α-β 剪枝
   - 增加评估函数深度

3. **技能系统测试**
   - 测试所有技能效果
   - 处理边界情况

4. **性能优化**
   - 数据库索引优化
   - WebSocket 连接池管理

5. **错误处理**
   - 完善错误提示
   - 添加日志系统

## 📝 注意事项

1. **MongoDB 连接**：确保 MongoDB 服务正常运行
2. **环境变量**：生产环境务必修改 JWT_SECRET
3. **CORS 配置**：根据前端地址配置 CORS
4. **微信配置**：需要真实的微信小程序 AppID 和 Secret

## 🐛 已知问题

- 微信登录目前使用模拟数据，需要接入真实 API
- AI 算法可以进一步优化
- 部分技能效果需要前端配合实现

## 📞 联系方式

如有问题，请查看代码注释或联系开发团队。

---

**版本：** v1.0.0  
**最后更新：** 2025-01-13

